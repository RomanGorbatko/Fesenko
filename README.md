Fesenko
=======

# Основные технологии

* **Node.js** - используется для создания серверной части приложения и позволяет использовать фреймворк Express и библиотеку Socket.IO. Кроме того, основная логика реализуется на стороне сервера и оформлена в виде отдельного Node-модуля, о котором мы поговорим позже.

* **Express** - сам по себе Node.js удовлетворяет многим требованиям, предъявляемым при разработке современных веб-приложений. Однако, добавление библиотеки Express позволит нам оптимизировать отдачу статичных файлов (HTML, CSS и JavaScript) пользователям. Мы также используем Express для логирования и реализации окружения, совместимого с Socket.IO.
* **EJS** - простейший HTML шаблонизатор.

* **Socket.IO** - эта библиотека позволяет очень просто реализовать обмен данными между браузером и сервером (в данном случае представляющим собой связку Node.js и Express) в реальном времени. Socket.IO использует протокол веб-сокетов, если он поддерживается браузером по умолчанию. Старые браузеры, такие как IE9, не поддерживают этот протокол — в этом случае Socket.IO будет использовать сокеты через Flash или AJAX-технологию long-polling.

* **MongoDB** - в качестве основного хранилища данных о пользователях и сообщениях.

Клиентский JavaScript – для простоты, на фронтенде используется всего одна JS-библиотека:
* **jQuery** – в основном используется для обработки событий и манипуляций с DOM.

* **CSS** – ...

# Разработка серверной части


Модули Express и Socket.IO не входят в Node.js. Они являются внешними зависимостями, которые должны быть загружены и установлены отдельно. Менеджер пакетов Node.js (npm) сделает это за нас при запуске команды npm install. То же самое он сделает со всеми зависимостями, перечисленными в файле package.json. Файл package.json вы можете найти в корневой директории проекта. Он содержит определяющий зависимости проекта JSON-объект:

```json
"dependencies": {
    "express": "3.x",
    "socket.io":"0.9"
}
```

Файл `app.js` в корневой директории проекта — это точка входа для всего приложения. Первые несколько строк инициализируют все необходимые модули. Express настроен для обеспечения доступа к статическим файлам, а модуль Socket.IO настроен так, чтобы отслеживать подключения к тому же порту, что и Express. Следующие строки — основа приложения, необходимая для работы сервера.

```javascript
// Создаем приложение с помощью Express
var app = express();

// Создаем HTTP-сервер с помощью модуля HTTP, входящего в Node.js. 
// Связываем его с Express и отслеживаем подключения к порту 8080. 
var server = http.createServer(app).listen(app.get('port'), function(){
  console.log('Express server listening on port ' + app.get('port'));
});

// Инициализируем Socket.IO так, чтобы им обрабатывались подключения 
// к серверу Express/HTTP
var io = require('socket.io').listen(server);
```

Весь код серверной части приложения вынесен в отдельные файлы-модули `./routes/*.js`. Этоти файлы подключается в приложение в качестве модуля Node с помощью следующего фрагмента кода (прим.): `var im = require('./routes/im');`. Когда клиент подключается к приложению с помощью Socket.IO, модуль `im` должен выполнять функцию `setConnection` в которую будет передан сокет-объект. За это отвечает следующий фрагмент кода:

```javascript
io.sockets.on('connection', function (socket) {
    im.IM.parentSocket = io.sockets;
    im.IM.setConnection(socket);
});
```

Функция `setConnection` собирает первичную информацию о пользователе, который зашел на сайт:
```javascript
    setConnection: function (socket) {
        this.socket = socket;
        this.socket.handshake.getSession(function(err, session) {
            if (IM.connectedUsers[session._sessionid] === undefined) {
                IM.connectedUsers[session._sessionid] = [];
            }

            IM.connectedUsers[session._sessionid].push(IM.socket.id);
        });
    },
```

Эта информация нужна будет для того, что бы отследить владельца socket-коннекта и дать возможность приложению четко определять конечного клиента для отправки сокета.

# Разработка клиентской части


Когда браузер подключается к приложению, сервер отдает ему файл `index.ejs` из директории `views`. 

Для подключения браузера к серверу Socket.IO требуется клиентская библиотека Socket.io. Так как мы используем Socket.IO через Express, мы можем использовать получить файл библиотеки с сервера с помощью следующего тега:

`<script src="/socket.io/socket.io.js"></script>`

Большая часть логики приложения и весь клиентский код расположен в файле `./public/javascript/im.js`.
Код заключен в Javascript-объект `IM`. Это означает, что все переменные и функции, используемые в приложении, являются свойствами объектов `IM`. Структура клиентского кода выглядит примерно так:

```javascript
IM = {
    socket: null,
    connect: function() {
        this.socket = Node.socket; // ссылка на Socket.io объект
        this.listenEvents();

    },
    listenEvents: function() {
        this.socket.on('events', function(data) {
            if (data.fn) {
                IM[data.fn](data.message);
            }
        });
    },
    send: function(el, prev) {
    
    },
    addMessage: function (data) {
    
    },
    refreshOnline: function(data) {
    
    }
};
```
